# Plan: Add *arr Stack to media-server Module

Date: 2026-01-09

## Summary

Extend the existing `media-server.nix` module to include the full *arr media acquisition stack: **Sonarr (shows)**, **Sonarr (anime)**, **Radarr (movies)**, **Radarr (anime)**, **Prowlarr**, **Lidarr**, **Bazarr**, **Jellyseerr**, and **qBittorrent**.

Services will be accessed through friendly domains (e.g. `anime.vereis.com`, `movies.vereis.com`) and **restricted to Tailscale clients only** via nginx allow/deny rules.

## Requirements

- Add Sonarr (shows), Sonarr (anime), Radarr (movies), Radarr (anime), Prowlarr, Lidarr, Bazarr, Jellyseerr, qBittorrent to kyubey
- All services share the existing `media` group for file permissions
- Single toggle option (`arr.enable`) to enable/disable the entire acquisition stack
- Services are exposed via nginx reverse proxy **over HTTP** (no ACME/TLS; domains point to Tailscale IP)
- Access restricted to Tailscale only (nginx `allow 100.64.0.0/10; deny all;`)
- Use existing `serve` module for nginx reverse proxy configuration
- qBittorrent WebUI password PBKDF2 hash stored in secrets (no plaintext in repo)
- Proper directory structure following TRaSH Guides best practices for hardlinks
- Sonarr/Radarr anime instances must be **v4** compatible (required for anime CF/scoring from TRaSH)

## Domains

These are the desired “friendly” domains (instead of per-service names):

| Domain | Service | Port |
|--------|---------|------|
| `shows.vereis.com` | Sonarr (shows) | 8989 |
| `anime.vereis.com` | Sonarr (anime) | 8990 |
| `movies.vereis.com` | Radarr (movies) | 7878 |
| `anime-movies.vereis.com` | Radarr (anime) | 7879 |
| `indexers.vereis.com` | Prowlarr | 9696 |
| `music.vereis.com` | Lidarr | 8686 |
| `subtitles.vereis.com` | Bazarr | 6767 |
| `requests.vereis.com` | Jellyseerr | 5055 |
| `torrents.vereis.com` | qBittorrent | 8080 |

## TRaSH Guides Best Practices (Incorporated)

### Folder Structure for Hardlinks

Everything must be on the **same filesystem** for hardlinks to work. Since `/storage` is a ZFS pool, we structure it as:

```
/storage/                        # ZFS pool root (same filesystem!)
├── torrents/                    # qBittorrent downloads (NEW)
│   ├── movies/                  # Radarr category
│   ├── anime-movies/            # Radarr (anime) category
│   ├── shows/                   # Sonarr (shows) category
│   ├── anime/                   # Sonarr (anime) category
│   └── music/                   # Lidarr category
└── media/                       # Final media library
    ├── movies/                  # Radarr library (NEW)
    ├── anime-movies/            # Radarr (anime) library (NEW)
    ├── shows/                   # Sonarr (shows) library (NEW)
    ├── anime/                   # Sonarr (anime) library (NEW)
    ├── music/                   # Lidarr library (NEW)
    ├── soundtracks/             # RENAMED from music/ (existing game OSTs)
    ├── games/                   # Existing
    └── .lood/                   # Existing
```

**Why this structure:**
- Downloads (`/storage/torrents`) and media (`/storage/media`) are on same ZFS pool
- Hardlinks work = instant moves, no extra disk space when seeding
- qBittorrent categories match folder names for auto-sorting
- Clear separation between "in-progress downloads" and "organized library"

### qBittorrent Configuration

- Default Save Path: `/storage/torrents`
- Torrent Management Mode: `Automatic`
- Categories: `movies`, `shows`, `anime`, `music` (auto-sort to subfolders)
- Web UI password: PBKDF2 hash in secrets

## Current State

### Existing `/storage` structure

```
/storage/
└── media/
    ├── games/
    ├── music/games/   (game soundtracks - TO BE RENAMED)
    └── .lood/
```

## Approach

Extend `modules/services/media-server.nix` with:

1. New `arr.enable` option that toggles all acquisition services as a group
2. Individual service configurations using NixOS's native service modules
3. Shared user/group management (reuse existing `media` group)
4. Directory creation via systemd tmpfiles rules
5. qBittorrent configured with PBKDF2 password hash from secrets
6. A second Sonarr instance for anime (separate data dir + port)

The nginx proxy configuration will be added to `hosts/linux/kyubey/services.nix` using the existing `serve` module with `ssl = false` and a Tailscale-only allow/deny snippet.

## Alternatives Considered

1. **Single Sonarr instance for everything**: Possible, but TRaSH’s anime workflow is cleaner with a separate instance.
2. **Separate `arr-stack.nix` module**: Cleaner separation but fragments related functionality. Keeping it in `media-server.nix` matches existing repo patterns.
3. **Auto-generate serve sites from media-server module**: Reduces config duplication but adds coupling. Manual serve config is explicit.
4. **Downloads inside media folder**: TRaSH recommends keeping downloads separate from the organized library.

## Implementation Steps

### Step 1: Add qBittorrent secret to secrets.json

Add PBKDF2-hashed password for qBittorrent web UI.

Files:
- `secrets/secrets.json`

### Step 2: Extend media-server.nix with arr stack options

Add new options under `modules.media-server.arr`:
- `enable` - boolean to toggle entire stack
- `downloadPath` - path for torrent downloads (default: `/storage/torrents`)

Files:
- `modules/services/media-server.nix`

### Step 3: Add arr services configuration

Configure all *arr services in the module:

- Sonarr (shows): `services.sonarr` on port 8989
- Sonarr (anime): a separate systemd unit on port 8990
- Radarr, Prowlarr, Lidarr, Bazarr, Jellyseerr
- qBittorrent with:
  - Web UI password from secrets (PBKDF2 format)
  - Download path: `/storage/torrents`
  - Torrent management mode: Automatic
  - Categories for `movies`, `shows`, `anime`, `music`

Shared:
- All services use `media` group
- Add all service users to `media` group

Files:
- `modules/services/media-server.nix`

### Step 4: Add directory structure via tmpfiles

Create systemd tmpfiles rules for TRaSH-compliant structure:

- `/storage/torrents`
- `/storage/torrents/movies`
- `/storage/torrents/shows`
- `/storage/torrents/anime`
- `/storage/torrents/music`
- `/storage/media/movies`
- `/storage/media/shows`
- `/storage/media/anime`
- `/storage/media/music`

Files:
- `modules/services/media-server.nix`

### Step 5: Enable arr stack in kyubey services

Add `arr.enable = true` to kyubey's media-server config.

Files:
- `hosts/linux/kyubey/services.nix`

### Step 6: Add nginx proxy sites for arr services

Add all domains to the `serve.sites` configuration with `ssl = false`.

For each of these, add a Tailscale-only allow/deny stanza (example):

```
allow 100.64.0.0/10;
deny all;
```

Files:
- `hosts/linux/kyubey/services.nix`

### Step 7: Update firewall configuration

- Remove port 51413 (Transmission port; not used in repo)
- Add qBittorrent torrenting port 6881 TCP (and consider UDP if needed)

Files:
- `hosts/linux/kyubey/default.nix`

### Step 8: Rename existing music directory on kyubey

Rename `/storage/media/music` to `/storage/media/soundtracks` to preserve game OSTs.
This is a manual step via SSH, not in Nix config.

## Files Affected

- `secrets/secrets.json` - Add qBittorrent PBKDF2 password hash
- `modules/services/media-server.nix` - Main implementation
- `hosts/linux/kyubey/services.nix` - Enable arr stack + serve sites
- `hosts/linux/kyubey/default.nix` - Update firewall

## Risks / Considerations

1. **Permissions**: All services need read/write access to both `/storage/torrents` and `/storage/media`. The `media` group handles this.
2. **Hardlink verification**: Verify hardlinks work by checking identical inodes after import.
3. **Service interdependencies**: Prowlarr ↔ Sonarr/Radarr, Sonarr/Radarr ↔ qBittorrent, etc. configured via each web UI after deployment.
4. **qBittorrent categories**: Create categories via UI to match folder structure.
5. **Tailscale-only restriction**: This is enforced at nginx layer; firewall still allows 80/443 for other public sites.

## Testing Strategy

1. `nix flake check`
2. `sudo nixos-rebuild switch --flake .#kyubey`
3. Verify services: `systemctl status sonarr sonarr-anime radarr prowlarr lidarr bazarr jellyseerr qbittorrent`
4. Verify directories + perms: `ls -la /storage/torrents /storage/media`
5. Verify firewall ports: `51413 removed, 6881 added`
6. Access each web UI via the domains above (after DNS setup)

## Post-Deployment Manual Steps

1. **Rename music directory** (SSH to kyubey):
   ```bash
   sudo mv /storage/media/music /storage/media/soundtracks
   ```

2. **Point DNS A records in Cloudflare** to kyubey's Tailscale IP:
   - `shows.vereis.com` -> 100.x.x.x
   - `anime.vereis.com` -> 100.x.x.x
   - `movies.vereis.com` -> 100.x.x.x
   - `anime-movies.vereis.com` -> 100.x.x.x
   - `indexers.vereis.com` -> 100.x.x.x
   - `music.vereis.com` -> 100.x.x.x
   - `subtitles.vereis.com` -> 100.x.x.x
   - `requests.vereis.com` -> 100.x.x.x
   - `torrents.vereis.com` -> 100.x.x.x

3. **Configure Sonarr/Radarr**

- For shows/movies: use the default instances, and set Series/Movie Type appropriately.
- For anime: use the separate instances and follow TRaSH anime quality profiles/scoring.

4. **Configure qBittorrent** (via web UI)

- Verify download path is `/storage/torrents`
- Set Torrent Management Mode to `Automatic`
- Create categories: `movies`, `anime-movies`, `shows`, `anime`, `music`

5. **Configure Prowlarr**

- Add indexers
- Connect to Sonarr (both), Radarr (both), Lidarr

6. **Configure Bazarr**

- Connect to Sonarr/Radarr
- Configure subtitle providers

7. **Configure Jellyseerr**

- Connect to Plex/Jellyfin
- Connect to Sonarr/Radarr

8. **Verify hardlinks working**

```bash
ls -li /storage/torrents/movies/SomeMovie.mkv /storage/media/movies/SomeMovie/SomeMovie.mkv
# inode (first column) should match
```
